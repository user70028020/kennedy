import{b as r,s as u,g as e}from"./CyUuy-wj.js";import{b as i}from"./DxC-crzK.js";const A="http://localhost:3000/api";function p(){let t=u(null),s=u(null),c=u(!1),l=u(!1);if(i){console.log("[Auth Store] Initializing from localStorage");const o=localStorage.getItem("token"),n=localStorage.getItem("user");if(console.log("[Auth Store] Stored token:",!!o),console.log("[Auth Store] Stored user:",!!n),o&&n){r(s,o,!0);try{const d=JSON.parse(n);r(t,d,!0),console.log("[Auth Store] Loaded user:",d.name,"Role:",d.role)}catch{console.error("[Auth Store] Failed to parse stored user"),r(t,null),localStorage.removeItem("user"),localStorage.removeItem("token")}}r(l,!0),console.log("[Auth Store] Initialization complete")}function f(o,n){r(t,o,!0),r(s,n,!0),i&&(localStorage.setItem("token",n),localStorage.setItem("user",JSON.stringify(o)))}function g(){r(t,null),r(s,null),i&&(localStorage.removeItem("token"),localStorage.removeItem("user"))}async function h(){if(console.log("[Auth Store] checkAuth called"),console.log("[Auth Store] Current token:",e(s)?"exists":"null"),console.log("[Auth Store] Current user:",e(t)?.name||"null"),!e(s))return console.log("[Auth Store] No token, returning false"),r(l,!0),!1;r(c,!0);try{console.log("[Auth Store] Fetching /auth/me...");const o=await fetch(`${A}/auth/me`,{headers:{Authorization:`Bearer ${e(s)}`}});if(console.log("[Auth Store] Response status:",o.status),!o.ok)return console.log("[Auth Store] Response not ok, clearing auth"),g(),!1;const n=await o.json();return console.log("[Auth Store] User data received:",n.name,"Role:",n.role),r(t,n,!0),i&&localStorage.setItem("user",JSON.stringify(n)),!0}catch(o){return console.error("[Auth Store] Fetch error:",o),e(t)&&e(s)?(console.warn("[Auth Store] Backend unreachable, using cached data"),!0):(g(),!1)}finally{r(c,!1),r(l,!0)}}function a(o){return e(t)?e(t).role==="admin"?!0:e(t).modules.includes(o):!1}function m(){return{fotografico:a("fotografico"),spda:a("spda"),rdo:a("rdo"),tecnico:a("tecnico"),gastos:a("gastos"),banco_dados:a("banco_dados"),gerenciar_usuarios:a("gerenciar_usuarios")}}function S(){return e(t)?e(t).role==="admin"?["fotografico","spda","rdo","tecnico","gastos","banco_dados","gerenciar_usuarios"]:e(t).modules:[]}return{get user(){return e(t)},get token(){return e(s)},get loading(){return e(c)},get initialized(){return e(l)},get isAuthenticated(){return!!e(t)&&!!e(s)},get isAdmin(){return e(t)?.role==="admin"},get permissions(){return m()},get availableModules(){return S()},login:f,logout:g,checkAuth:h,hasModule:a}}const b=p();export{b as a};
