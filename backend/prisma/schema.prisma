// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  funcionario
}

enum UserStatus {
  ativo
  inativo
}

enum ServiceOrderStatus {
  ativa
  concluida
  cancelada
}

enum TemplateType {
  nx_energy
  sercamp
  merge
}

enum ReportType {
  fotografico
  spda
  rdo
  tecnico
  gastos
  mesclado
}

enum TemplateCategory {
  equipment
  merge
}

enum AuditAction {
  login
  logout
  create
  update
  delete
  download
  generate
}

enum ResourceType {
  user
  report
  template
  service_order
  merge
}

enum InspectionStatus {
  conforme
  corretiva
  alerta
}

model User {
  id           String     @id @default(uuid())
  name         String
  email        String     @unique
  passwordHash String
  role         UserRole   @default(funcionario)
  modules      String[]   @default([])
  status       UserStatus @default(ativo)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  deletedAt    DateTime?  // Soft delete

  // Relations
  serviceOrders ServiceOrder[] @relation("CreatedBy")
  reports       Report[]       @relation("GeneratedBy")
  auditLogs     AuditLog[]

  @@map("users")
}

model ServiceOrder {
  id               String             @id @default(uuid())
  osNumber         String             @unique
  clientName       String
  clientLogo       String?
  teamLeader       String
  teamMembers      String[]           @default([])
  equipmentType    String
  selectedTemplate TemplateType       @default(nx_energy)
  serviceType      String
  location         String
  periodStart      DateTime
  periodEnd        DateTime
  status           ServiceOrderStatus @default(ativa)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  deletedAt        DateTime?          // Soft delete

  // Relations
  createdById String
  createdBy   User                 @relation("CreatedBy", fields: [createdById], references: [id])
  reports     Report[]
  pesquisas   PesquisaSatisfacao[]

  @@map("service_orders")
}

model Report {
  id          String       @id @default(uuid())
  type        ReportType
  osNumber    String
  clientName  String
  fileName    String
  fileData    String       @db.Text
  fileSize    Int
  template    TemplateType @default(nx_energy)
  createdAt   DateTime     @default(now())
  deletedAt   DateTime?    // Soft delete

  // Relations
  generatedById  String
  generatedBy    User          @relation("GeneratedBy", fields: [generatedById], references: [id])
  serviceOrderId String?
  serviceOrder   ServiceOrder? @relation(fields: [serviceOrderId], references: [id])

  @@map("reports")
}

model Template {
  id        String           @id @default(uuid())
  name      String
  type      TemplateCategory
  category  String
  fileName  String
  fileData  String           @db.Text
  fileSize  Int
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  deletedAt DateTime?        // Soft delete

  @@map("templates")
}

model AuditLog {
  id           String       @id @default(uuid())
  userId       String
  userName     String
  action       AuditAction
  resourceType ResourceType
  resourceId   String?
  details      String
  ipAddress    String?
  timestamp    DateTime     @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model PesquisaSatisfacao {
  id                String   @id @default(uuid())
  osNumber          String
  razaoSocial       String
  responsavel       String
  telefone          String
  cidade            String
  uf                String
  cep               String
  endereco          String
  atendimento       Int      @db.SmallInt
  apresentacao      Int      @db.SmallInt
  prazo             Int      @db.SmallInt
  competencia       Int      @db.SmallInt
  confiabilidade    Int      @db.SmallInt
  recomendaria      Boolean
  sugestoes         String?
  createdAt         DateTime @default(now())

  // Relations
  serviceOrderId String?
  serviceOrder   ServiceOrder? @relation(fields: [serviceOrderId], references: [id])

  @@map("pesquisas_satisfacao")
}

model Colaborador {
  id        String    @id @default(uuid())
  nome      String
  documento String    @unique
  funcao    String
  email     String?
  telefone  String?
  osCount   Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  @@map("colaboradores")
}

// Backup model for system backups
model Backup {
  id          String   @id @default(uuid())
  name        String
  description String?
  fileData    String   @db.Text // JSON with all data
  fileSize    Int
  createdAt   DateTime @default(now())
  createdById String

  @@map("backups")
}
